# MCDA Core Skill - User Story

## 📖 故事背景

### 业务场景
作为产品经理、技术负责人或决策者，你经常需要在多个场景下做结构化决策：
- **产品选型**: 从 3 个 SaaS 产品中选择最佳方案（成本、功能、稳定性权衡）
- **供应商评估**: 从 5 个供应商中选择合作伙伴（价格、质量、交付期平衡）
- **人才招聘**: 从 4 个候选人中筛选最合适的人选（技能、经验、文化匹配）
- **投资决策**: 从 6 个投资项目中排序（ROI、风险、流动性考量）

### 问题现状
传统决策方式存在以下痛点：
- ❌ **主观直觉**: "我觉得方案 B 好"——缺乏数据支撑
- ❌ **单一维度**: "只看成本，选 A"——忽略其他重要因素
- ❌ **无法量化**: "方案 B 功能强，但贵多少值得？"——缺乏权衡标准
- ❌ **不透明**: 决策过程难以追溯和解释

### 解决方案
使用 **MCDA Core**（多准则决策分析核心框架）进行结构化决策：

```
决策准则（权重总和 = 1.0）:
├── 成本（30%）
├── 功能完整性（40%）
├── 实施周期（20%）
└── 风险可控性（10%）

评分标准（1-5 分制）:
- 5 分: 优秀
- 3 分: 中等
- 1 分: 较差

加权计算:
方案 A 得分 = 5×0.3 + 2×0.4 + 4×0.2 + 3×0.1 = 3.4
方案 B 得分 = 1×0.3 + 5×0.4 + 2×0.2 + 2×0.1 = 3.1
方案 C 得分 = 3×0.3 + 4×0.4 + 3×0.2 + 4×0.1 = 3.5 ✅

结论: 方案 C 综合得分最高，选择 C
```

### Value Proposition
MCDA Core 为决策者提供：
- ✅ **结构化决策**: 将复杂问题分解为可量化指标
- ✅ **透明化权衡**: 清楚看到各因素的权重影响
- ✅ **可复用方法**: 适用于多种决策场景
- ✅ **AI 辅助**: Claude 帮助构建决策矩阵、计算得分、生成报告
- ✅ **稳健性分析**: 敏感性分析识别关键决策因素

---

## 🎯 用户角色

### 主要用户
1. **产品经理**: 需要在多个产品方案中做决策
2. **技术负责人**: 需要评估技术栈、供应商、工具
3. **项目经理**: 需要优先级排序、资源分配
4. **业务分析师**: 需要量化评估和决策支持

### 使用场景
| 场景 | 备选方案数 | 准则数 | 决策复杂度 |
|------|-----------|--------|-----------|
| SaaS 产品选型 | 3-5 个 | 3-6 个 | Medium |
| 供应商评估 | 5-10 个 | 4-8 个 | High |
| 人才招聘 | 3-7 个 | 3-5 个 | Medium |
| 投资决策 | 5-15 个 | 3-7 个 | High |

---

## 📝 使用示例

### 场景：选择云服务供应商

**Step 1: 定义决策问题**
```yaml
# decision.yaml
problem: "选择最佳云服务供应商"

alternatives:
  - AWS
  - Azure
  - GCP

criteria:
  - name: 成本
    weight: 0.35
    direction: lower_better
    description: 月度成本（万元）
  - name: 功能完整性
    weight: 0.30
    direction: higher_better
    description: 功能覆盖率（%）
  - name: 稳定性
    weight: 0.25
    direction: higher_better
    description: 可用性 SLA（%）
  - name: 技术支持
    weight: 0.10
    direction: higher_better
    description: 支持响应时间（小时）

scores:
  AWS:
    成本: 3
    功能完整性: 5
    稳定性: 5
    技术支持: 4
  Azure:
    成本: 4
    功能完整性: 4
    稳定性: 4
    技术支持: 5
  GCP:
    成本: 5
    功能完整性: 4
    稳定性: 4
    技术支持: 3

algorithm:
  name: wsm
```

**Step 2: 运行 MCDA 分析**
```bash
python scripts/mcda.py validate decision.yaml
python scripts/mcda.py calculate decision.yaml
python scripts/mcda.py report decision.yaml --output decision-report.md
```

**Step 3: 查看决策报告**
```markdown
# MCDA 决策分析报告

## 加权评分结果

| 排名 | 供应商 | 得分 | 关键优势 |
|------|--------|------|----------|
| 🥇 1 | AWS | **4.05** | 功能最完整，稳定性最高 |
| 🥈 2 | Azure | **4.15** | 技术支持最好，成本适中 |
| 🥉 3 | GCP | **4.10** | 成本最低 |

## 敏感性分析
- 若成本权重增加 15%，GCP 排名第 1
- 当前配置下，AWS 排名稳定

## 建议
1. 推荐 **Azure**（综合得分最高，技术支持优势明显）
2. 若成本敏感，考虑 GCP
3. 若功能需求强，考虑 AWS
```

---

## 🎯 用户需求

### 功能需求

#### 0. 评分制度改进（v2.0 更新）⭐

**原需求（v1.0）**: 1-5 分制（Likert scale）
**新需求（v2.0）**: **0-100 分制（百分制）**

**理由**:
- ✅ 更直观，符合日常百分制习惯
- ✅ 精度更高，能区分细微差异（如 75 分 vs 78 分）
- ✅ 方便归一化处理（0-1 映射）
- ✅ 用户反馈："希望能用 0-100 分制"

**影响范围**:
- 数据模型: `ScoreRange = (0.0, 100.0)`
- 验证逻辑: 检查评分在 0-100 范围内
- 报告生成: 可选显示百分号（"75 分"或 "75%"）

---

#### 1. 指标评分计算能力（v2.0 新增）⭐

**原需求（v1.0）**: 用户直接提供各指标的评分
**新需求（v2.0）**: **支持配置评分规则，自动计算评分**

**使用场景**:
用户有原始数据（如成本 20 万元、响应时间 300ms），希望通过评分规则自动转换为 0-100 分。

**支持的评分规则类型**:

| 规则类型 | 描述 | 适用场景 | 复杂度 |
|---------|------|---------|--------|
| **Linear** | 线性映射 | 连续数值（成本、时间、百分比） | Low |
| **Threshold** | 阈值分段 | 等级划分（优秀/良好/一般） | Medium |

**LinearScoringRule 示例**:
```yaml
criteria:
  - name: 成本
    weight: 0.3
    direction: lower_better
    scoring_rule:
      type: linear
      min: 0          # 最小值（万元）
      max: 100        # 最大值（万元）
      scale: 100      # 满分值
    # 计算: 成本 20 万 → score = 100 * (1 - 20/100) = 80 分
```

**ThresholdScoringRule 示例**:
```yaml
criteria:
  - name: 响应时间
    weight: 0.2
    direction: lower_better
    scoring_rule:
      type: threshold
      ranges:
        - {max: 100, score: 100}        # < 100ms → 100 分
        - {min: 100, max: 500, score: 80}   # 100-500ms → 80 分
        - {min: 500, max: 1000, score: 60}  # 500-1000ms → 60 分
        - {min: 1000, score: 40}        # > 1000ms → 40 分
```

**向后兼容**: 不配置 `scoring_rule` 时，用户仍可直接提供 `scores`

---

#### 2. 数据源导入支持（v2.0 新增）⭐

**原需求（v1.0）**: 仅支持 YAML 配置
**新需求（v2.0）**: **支持 Excel/CSV 结构化数据导入**

**支持的数据格式**:

| 格式 | 状态 | 依赖 | 说明 |
|------|------|------|------|
| **YAML** | 必需 | pyyaml | 配置文件 + 数据 |
| **CSV** | 必需 | 标准库 csv | 零外部依赖 |
| **Excel** | 可选 | openpyxl | 按需安装 |

**Excel 数据示例**:
```
| 方案   | 成本(万元) | 响应时间 | 稳定性(%) |
|--------|-----------|---------|----------|
| AWS    | 20        | 150     | 99.9     |
| Azure  | 50        | 80      | 99.5     |
| GCP    | 35        | 120     | 99.7     |
```

**配置文件示例**:
```yaml
data_source:
  type: excel
  file: data/vendor_data.xlsx
  sheet: 决策数据

criteria:
  - name: 成本
    column: 成本(万元)  # 映射到 Excel 列
    weight: 0.3
    scoring_rule: {...}
```

---

#### 3. 决策问题定义（v1.0 保持）
   - 支持 YAML 配置格式
   - 定义备选方案列表
   - 定义评价准则（名称、权重、方向）
   - 定义评分矩阵

#### 4. 数据验证（v2.0 更新）
   - 权重总和检查（= 1.0 或自动归一化）
   - 评分范围检查（**0-100 分制**）← 更新
   - 最小方案数检查（≥ 2）
   - 最小准则数检查（≥ 2）
   - 评分规则验证（类型检查、参数合理性）← 新增

#### 5. 算法计算（architect agent 审查后调整）

**v0.2 MVP（2 周，10 人日）**:
- ✅ **WSM**（Weighted Sum Model）- 加权算术平均
- ✅ **WPM**（Weighted Product Model）- 加权几何平均
- ✅ **TOPSIS** - 逼近理想解排序法（距离算法）
- ✅ **VIKOR** - 折衷排序法（⭐ 唯一提供折衷解）
- 支持 higher_better / lower_better 方向性
- 排序和排名

**v0.3 基础扩展（4 周，19 人日）**:
- **PROMETHEE-II** - 优先排序法（偏好关系）
- **COPRAS** - 复杂比例评估（效用型）

**v0.4 高级功能（6 周，31 人日）**:
- **SAW** - 简单加权法
- **TODIM** - 前景理论算法
- **ELECTRE-I** - 消除与选择转换法
- **MACBETH** - 定性偏好量化
- **MOORA** - 比率分析多目标优化
- **ORESTE** - 关系数据排序

**详细优先级参考**:
- [ADR-004: 汇总算法架构设计](../decisions/004-mcda-aggregation-algorithms.md)

---

#### 6. 标准化方法（architect agent 审查后调整）

**v0.2 MVP（1.5 人日）**:
- ✅ **MinMax** - 线性映射到 [0,1]
- ✅ **Vector** - 向量归一化（TOPSIS 必需）

**v0.3 基础扩展（3 人日）**:
- **Z-Score** - 标准分数（正态分布）
- **Sum** - 总和归一化（比例型数据）
- **Inverse** - 反向线性映射

**v0.4 高级功能（5 人日）**:
- **Max** - 最大值归一化
- **Threshold** - 阶梯函数
- **Logarithmic** - 对数变换
- **Sigmoid** - S 型曲线

**详细优先级参考**:
- [ADR-002: 标准化方法架构设计](../decisions/002-mcda-normalization-methods.md)

---

#### 7. 赋权方法（architect agent 审查后调整）

**v0.2 MVP（0.5 人日）**:
- ✅ **直接赋权** - 用户手动指定权重（最常见场景）

**v0.3 基础扩展（6 人日）**:
- **熵权法** - 基于信息熵的客观赋权
- **AHP** - 层次分析法（主观赋权，最热门）

**v0.4 高级功能（10 人日）**:
- **CRITIC 法** - 对比强度 + 冲突性
- **变异系数法** - 基于数据变异
- **标准离差法** - 基于离散程度
- **离差最大化法** - 最大化方案差异

**v0.5 特殊场景（10.5 人日）**:
- **德尔菲法** - 多轮专家咨询
- **PCA** - 主成分分析（降维）
- **组合赋权** - 主客观组合策略

**详细优先级参考**:
- [ADR-003: 赋权方法路线图](../decisions/003-mcda-weighting-roadmap.md)

---

#### 8. 敏感性分析
   - 权重扰动测试（±10%）
   - 排名变化检测
   - 关键权重识别

#### 9. 报告生成
   - Markdown 格式输出
   - 排名表格
   - 得分详情
   - 决策建议

### 非功能需求
- **易用性**: YAML 配置，CLI 命令
- **可扩展性**: 支持未来添加 AHP、TOPSIS 等算法
- **性能**: 100 个备选方案 × 20 个准则，计算时间 < 1 秒
- **可靠性**: 测试覆盖率 ≥ 80%
- **兼容性**: Python 3.12+

---

## 🏗️ 架构需求

### 架构视角的功能性需求

| 需求类别 | 描述 | 优先级 | 验收标准 |
|---------|------|--------|---------|
| **数据模型独立性** | 数据模型与算法解耦，支持多种算法共享同一数据结构 | P0 | 新算法无需修改数据模型 |
| **算法可插拔性** | 新算法（AHP、TOPSIS）通过继承基类实现，无需修改核心代码 | P0 | 添加算法 < 100 行代码 |
| **验证可配置性** | 验证规则可配置，支持不同算法的不同验证需求 | P1 | 每个算法可自定义验证逻辑 |
| **报告可扩展性** | 报告格式可定制，支持多种输出格式（Markdown、JSON、HTML） | P1 | 新增输出格式 < 50 行代码 |
| **并发安全性** | 算法实例无状态，支持并发计算 | P1 | 多线程环境无数据竞争 |

### 架构视角的非功能性需求

| 需求类别 | 指标 | 测量方法 | 当前目标 |
|---------|------|---------|---------|
| **性能** | 100方案×20准则 < 1秒 | 基准测试（pytest-benchmark） | < 500ms |
| **可扩展性** | 添加新算法 < 100行代码 | 代码量统计 | < 80 行 |
| **可测试性** | 各层测试可独立运行 | 单元测试隔离 | 100% 隔离 |
| **类型安全** | 100%类型注解覆盖 | mypy 静态检查 | --strict 模式通过 |
| **内存效率** | 100×20 矩阵 < 10MB | 内存分析（memory_profiler） | < 5MB |
| **模块耦合度** | 模块间依赖单向 | 依赖图分析 | 无循环依赖 |

### 技术约束

**编程语言与版本**:
- Python 3.12+ (利用新特性)
  - 类型系统改进 (PEP 695)
  - dataclass 增强功能
  - f-string 调试改进
  - 性能优化（10-15% 提升）

**依赖约束**:
- ✅ **允许依赖**: pyyaml, numpy, pytest
- ❌ **不允许依赖**: pandas, scipy（保持轻量）
- ❌ **不允许依赖**: web 框架（保持纯 CLI）

**架构约束**:
- **无状态设计**: 算法实例必须无状态，支持并发
- **不可变数据**: 核心数据模型使用 `frozen=True` dataclass
- **接口优先**: 使用抽象基类（ABC）定义算法接口
- **单一职责**: 每个模块只负责一个核心功能

**设计原则**:
1. **SOLID 原则**:
   - 单一职责：每个类只做一件事
   - 开闭原则：对扩展开放，对修改关闭
   - 里氏替换：子类可替换基类
   - 接口隔离：接口精简，不强制依赖不需要的方法
   - 依赖倒置：依赖抽象而非具体实现

2. **分层架构**:
   - 数据模型层 → 算法抽象层 → 核心服务层 → 应用层 → 扩展层
   - 上层依赖下层，下层不依赖上层
   - 层间通信通过明确定义的接口

3. **可测试性**:
   - 每层可独立测试
   - 使用依赖注入支持 Mock
   - 避免全局状态

---

## 🚀 用户旅程

### 初次使用者
1. **发现问题**: 面对多个方案，难以决策
2. **寻找工具**: 了解 MCDA Core skill
3. **学习使用**: 阅读 README 和 examples
4. **首次尝试**: 使用简单模板（3 方案 × 3 准则）
5. **获得结果**: 看到清晰排名和建议
6. **建立信任**: 通过敏感性分析验证稳健性
7. **复用方法**: 应用到其他决策场景

### 熟练使用者
1. **快速定义**: 直接编写 YAML 配置
2. **批量分析**: 使用脚本处理多个决策问题
3. **高级功能**: 自定义算法参数
4. **团队协作**: 分享决策模板和报告
5. **持续优化**: 根据反馈调整权重和准则

---

## 🎨 用户界面

### CLI 命令行界面
```bash
# 验证配置
mcda validate decision.yaml

# 计算得分
mcda calculate decision.yaml

# 生成报告
mcda report decision.yaml --output report.md

# 敏感性分析
mcda sensitivity decision.yaml

# 一键执行
mcda run decision.yaml --output report.md
```

### YAML 配置界面
```yaml
# 简洁直观的配置格式
alternatives:
  - 方案 A
  - 方案 B

criteria:
  - name: 成本
    weight: 0.4
    direction: lower_better

scores:
  方案 A:
    成本: 5
```

### Markdown 报告界面
```markdown
# 清晰可读的决策报告
## 加权评分结果
| 排名 | 方案 | 得分 |
## 敏感性分析
## 决策建议
```

---

## 💡 用户反馈

### 预期正面反馈
- "决策过程变得透明和可解释"
- "多因素权衡变得简单"
- "敏感性分析帮助我理解风险"
- "YAML 配置很直观"

### 潜在改进方向
- 支持 JSON 输入格式
- 添加可视化图表（雷达图、柱状图）
- 支持多人决策权重聚合
- Web UI 界面
- 导出 Excel/PDF 报告

---

## 📊 成功指标

### 用户采用
- ✅ 决策问题配置成功率 ≥ 95%
- ✅ 报告生成成功率 = 100%
- ✅ 用户复用率 ≥ 60%

### 决策质量
- ✅ 决策时间减少 ≥ 50%
- ✅ 决策满意度提升 ≥ 40%
- ✅ 决策可追溯性 = 100%

### 技术指标
- ✅ 测试覆盖率 ≥ 80%
- ✅ 计算准确率 = 100%
- ✅ 响应时间 < 1 秒（100×20 矩阵）

---

**文档版本**: v1.0
**创建日期**: 2025-01-31
**维护者**: hunkwk + AI collaboration
